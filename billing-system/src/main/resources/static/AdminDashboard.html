<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
        .active { background-color: #4a5568; color: white; }
        .banner-preview { max-width: 300px; height: auto; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white p-6">
            <h2 class="text-2xl font-bold mb-6">Pahana Edu Bookshop</h2>
            <nav>
                <a href="#manage-items" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link active">Manage Items</a>
                <a href="#view-orders" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link">View Orders</a>
                <a href="#user-management" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link">User  Management</a>
                <a href="#banner-management" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link">Banner Management</a>
                <a href="/home" class="block py-2 px-4 rounded hover:bg-gray-700">Back to Home</a>
                <a href="/logout" class="block py-2 px-4 rounded hover:bg-gray-700">Logout</a>
            </nav>
            <div class="mt-6">
                <label for="theme" class="block text-sm">Themes:</label>
                <select id="theme" class="mt-1 p-2 w-full bg-gray-700 rounded" aria-label="Select Theme">
                    <option>Light</option>
                    <option>Dark</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 overflow-auto">
            <!-- Manage Items Section -->
            <div id="manage-items" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Manage Items</h2>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="text-xl font-semibold mb-4">Add New Item</h3>
                    <form id="add-item-form" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="item-name" class="block text-sm font-medium">Item Name</label>
                            <input type="text" id="item-name" name="name" class="w-full p-2 border rounded" aria-label="Item Name" required />
                        </div>
                        <div class="mb-4">
                            <label for="item-price" class="block text-sm font-medium">Item Price (LKR)</label>
                            <input type="number" id="item-price" name="price" step="0.01" class="w-full p-2 border rounded" aria-label="Item Price in LKR" required />
                        </div>
                        <div class="mb-4">
                            <label for="item-stock" class="block text-sm font-medium">Stock</label>
                            <input type="number" id="item-stock" name="stock" class="w-full p-2 border rounded" aria-label="Stock Quantity" required />
                        </div>
                        <div class="mb-4">
                            <label for="item-author" class="block text-sm font-medium">Author</label>
                            <input type="text" id="item-author" name="author" class="w-full p-2 border rounded" aria-label="Author Name" required />
                        </div>
                        <div class="mb-4">
                            <label for="item-image" class="block text-sm font-medium">Item Image</label>
                            <input type="file" id="item-image" name="image" accept="image/*" class="w-full p-2 border rounded" aria-label="Upload Item Image" />
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">Add Item</button>
                    </form>
                    <div id="recent-items" class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Recently Added Items</h3>
                        <table class="w-full border">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="p-2">Item Name</th>
                                    <th class="p-2">Price (LKR)</th>
                                    <th class="p-2">Stock</th>
                                    <th class="p-2">Author</th>
                                    <th class="p-2">Image</th>
                                </tr>
                            </thead>
                            <tbody id="recent-items-table"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white p-6 rounded shadow mt-6">
                    <h3 class="text-xl font-semibold mb-4">Inventory</h3>
                    <table class="w-full border">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2">Item Name</th>
                                <th class="p-2">Price (LKR)</th>
                                <th class="p-2">Stock</th>
                                <th class="p-2">Author</th>
                                <th class="p-2">Image</th>
                                <th class="p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- View Orders Section -->
            <div id="view-orders" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">View Orders</h2>
                <div class="bg-white p-6 rounded shadow">
                    <p>Orders management functionality will be implemented here.</p>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="user-management" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">User Management</h2>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="text-xl font-semibold mb-4">Add New User</h3>
                    <form id="add-user-form">
                        <div class="mb-4">
                            <label for="user-username" class="block text-sm font-medium">Username</label>
                            <input type="text" id="user-username" name="username" class="w-full p-2 border rounded" required />
                        </div>
                        <div class="mb-4">
                            <label for="user-email" class="block text-sm font-medium">Email</label>
                            <input type="email" id="user-email" name="email" class="w-full p-2 border rounded" required />
                        </div>
                        <div class="mb-4">
                            <label for="user-password" class="block text-sm font-medium">Password</label>
                            <input type="password" id="user-password" name="password" class="w-full p-2 border rounded" required />
                        </div>
                        <div class="mb-4">
                            <label for="user-role" class="block text-sm font-medium">Role</label>
                            <select id="user-role" name="role" class="w-full p-2 border rounded" required>
                                <option value="">Select Role</option>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">Add User</button>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">User List</h3>
                        <table class="w-full border">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="p-2">ID</th>
                                    <th class="p-2">Username</th>
                                    <th class="p-2">Email</th>
                                    <th class="p-2">Role</th>
                                    <th class="p-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Banner Management Section -->
            <div id="banner-management" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Banner Management</h2>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="text-xl font-semibold mb-4">Current Banner</h3>
                    <div class="mb-4">
                        <img id="current-banner" src="" alt="Current banner preview" class="banner-preview" />
                    </div>
                    <p class="text-sm mb-4 text-gray-600">Banner displays at 1200x400 (3:1 ratio). Important content should be centered.</p>
                    <h3 class="text-xl font-semibold mb-4">Upload New Banner Image</h3>
                    <form id="banner-form" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="banner-image" class="block text-sm font-medium">Select Banner Image:</label>
                            <input type="file" id="banner-image" name="banner" accept="image/*" class="w-full p-2 border rounded" required />
                            <small class="text-gray-500">Image will be automatically resized to 1200x400 pixels</small>
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">Upload & Resize</button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4">Notification</h3>
            <p id="modal-message" class="mb-4"></p>
            <div class="flex justify-end">
                <button id="modal-close" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Tab Navigation
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                tabLinks.forEach(l => l.classList.remove('active'));
                tabContents.forEach(c => c.classList.add('hidden'));
                link.classList.add('active');
                const target = document.querySelector(link.getAttribute('href'));
                if (target) {
                    target.classList.remove('hidden');
                    // Load users when user management tab is shown
                    if (link.getAttribute('href') === '#user-management') {
                        loadUsers();
                    }
                    // Load banner when banner management tab is shown
                    if (link.getAttribute('href') === '#banner-management') {
                        loadBanner();
                    }
                }
            });
        });

        // Modal functions
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Store items and users locally for UI update
        let items = [];
        let users = [];

        // Load items from backend and update tables
        async function loadItems() {
            try {
                const response = await fetch('/api/items');
                if (!response.ok) throw new Error('Failed to fetch items');
                items = await response.json();
                updateInventoryTable();
                updateRecentItemsTable();
            } catch (error) {
                console.error(error);
                showModal('Error loading items: ' + error.message);
            }
        }

        // Update Inventory Table
        function updateInventoryTable() {
            const tableBody = document.getElementById('inventory-table');
            tableBody.innerHTML = '';
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.price.toFixed(2)}</td>
                    <td class="p-2">${item.stock}</td>
                    <td class="p-2">${item.author}</td>
                    <td class="p-2"><img src="${item.imageUrl || ''}" alt="${item.name}" class="w-16 h-16 object-cover"></td>
                    <td class="p-2">
                        <button class="bg-red-500 text-white px-2 py-1 rounded delete-item" data-id="${item.id}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Attach delete event listeners
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    if (!confirm('Are you sure you want to delete this item?')) return;
                    try {
                        const res = await fetch(`/api/items/${id}`, { method: 'DELETE' });
                        if (!res.ok) throw new Error('Failed to delete item');
                        items = items.filter(i => i.id !== id);
                        updateInventoryTable();
                        updateRecentItemsTable();
                        showModal('Item deleted successfully');
                    } catch (error) {
                        console.error(error);
                        showModal('Error deleting item: ' + error.message);
                    }
                });
            });
        }

        // Update Recent Items Table (last 3 items)
        function updateRecentItemsTable() {
            const tableBody = document.getElementById('recent-items-table');
            tableBody.innerHTML = '';
            items.slice(-3).forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.price.toFixed(2)}</td>
                    <td class="p-2">${item.stock}</td>
                    <td class="p-2">${item.author}</td>
                    <td class="p-2"><img src="${item.imageUrl || ''}" alt="${item.name}" class="w-16 h-16 object-cover"></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Handle Add New Item form submission
        document.getElementById('add-item-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch('/api/items', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to add item');
                }

                const newItem = await response.json();
                items.push(newItem);
                updateInventoryTable();
                updateRecentItemsTable();
                form.reset();
                showModal('Item added successfully: ' + newItem.name);
            } catch (error) {
                console.error(error);
                showModal('Error adding item: ' + error.message);
            }
        });

        // User Management Functions
        // Function to load users from backend and update the table
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Failed to fetch users');
                users = await response.json();
                updateUsersTable();
            } catch (error) {
                console.error(error);
                showModal('Error loading users: ' + error.message);
            }
        }

        // Function to update the users table in the UI
        function updateUsersTable() {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = ''; // Clear existing rows

            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${user.id || user._id}</td>
                    <td class="p-2">${user.username}</td>
                    <td class="p-2">${user.email}</td>
                    <td class="p-2">${user.role}</td>
                    <td class="p-2">
                        <button class="bg-red-500 text-white px-2 py-1 rounded delete-user" data-id="${user.id || user._id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', async () => {
                    const id = button.getAttribute('data-id');
                    if (!confirm('Are you sure you want to delete this user?')) return;

                    try {
                        const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                        if (!res.ok) throw new Error('Failed to delete user');
                        // Remove user from local array and update table
                        users = users.filter(u => (u.id || u._id) !== id);
                        updateUsersTable();
                        showModal('User deleted successfully');
                    } catch (error) {
                        console.error(error);
                        showModal('Error deleting user: ' + error.message);
                    }
                });
            });
        }

        // Handle form submission to add a new user
        document.getElementById('add-user-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const form = event.target;
            const data = {
                username: form.username.value.trim(),
                email: form.email.value.trim(),
                password: form.password.value,
                role: form.role.value
            };

            // Basic validation
            if (!data.username || !data.email || !data.password || !data.role) {
                showModal('Please fill all user fields');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to add user');
                }

                const newUser = await response.json();
                users.push(newUser);
                updateUsersTable();
                form.reset();
                showModal('User added successfully: ' + newUser.username);
            } catch (error) {
                console.error(error);
                showModal('Error adding user: ' + error.message);
            }
        });

        // Banner Management Functions
        // Load current banner image from backend
        async function loadBanner() {
            try {
                const res = await fetch('/api/banner');
                if (!res.ok) throw new Error('Failed to fetch banner');
                const banner = await res.json();
                if (banner.imageUrl) {
                    document.getElementById('current-banner').src = banner.imageUrl;
                }
            } catch (error) {
                console.error('Error loading banner:', error);
                // It's okay if no banner exists yet
            }
        }

        // Handle banner upload form submission
        document.getElementById('banner-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const fileInput = document.getElementById('banner-image');
            if (fileInput.files.length === 0) {
                showModal('Please select a banner image to upload.');
                return;
            }

            const file = fileInput.files[0];
            if (!file.type.startsWith('image/')) {
                showModal('Please select a valid image file.');
                return;
            }

            // Resize image client-side to 1200x400 before upload
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = async function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = 1200;
                    canvas.height = 400;
                    const ctx = canvas.getContext('2d');

                    // Calculate cropping to maintain aspect ratio 3:1
                    const aspectRatio = img.width / img.height;
                    const canvasRatio = canvas.width / canvas.height;
                    let sx, sy, sWidth, sHeight;

                    if (aspectRatio > canvasRatio) {
                        // Image wider than canvas ratio: crop width
                        sHeight = img.height;
                        sWidth = sHeight * canvasRatio;
                        sx = (img.width - sWidth) / 2;
                        sy = 0;
                    } else {
                        // Image taller than canvas ratio: crop height
                        sWidth = img.width;
                        sHeight = sWidth / canvasRatio;
                        sx = 0;
                        sy = (img.height - sHeight) / 2;
                    }

                    ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(async function(blob) {
                        const formData = new FormData();
                        formData.append('banner', blob, 'banner.jpeg');

                        try {
                            const res = await fetch('/api/banner', {
                                method: 'POST',
                                body: formData
                            });
                            if (!res.ok) {
                                const text = await res.text();
                                throw new Error(text || 'Failed to upload banner');
                            }
                            const bannerData = await res.json();
                            document.getElementById('current-banner').src = bannerData.imageUrl;
                            document.getElementById('banner-form').reset();
                            showModal('Banner uploaded and resized successfully!');
                        } catch (error) {
                            console.error('Error uploading banner:', error);
                            showModal('Error uploading banner: ' + error.message);
                        }
                    }, 'image/jpeg', 0.8);
                };
                img.onerror = function() {
                    showModal('Error loading image file.');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Initial load
        loadItems();

    </script>
</body>
</html>
