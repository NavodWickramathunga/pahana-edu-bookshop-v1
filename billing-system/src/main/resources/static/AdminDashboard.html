<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .active { background-color: #4a5568; color: white; }
        .banner-preview { max-width: 300px; height: auto; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white p-6">
            <h2 class="text-2xl font-bold mb-6">Pahana Edu Bookshop</h2>
            <nav>
                <a href="#manage-items" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link">Manage Items</a>
                <a href="#view-orders" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link">View Orders</a>
                <a href="#user-management" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link">User Management</a>
                <a href="#banner-management" class="block py-2 px-4 rounded hover:bg-gray-700 tab-link">Banner Management</a>
                <a href="/home" class="block py-2 px-4 rounded hover:bg-gray-700">Back to Home</a>
                <a href="/logout" class="block py-2 px-4 rounded hover:bg-gray-700">Logout</a>
            </nav>
            <div class="mt-6">
                <label for="theme" class="block text-sm">Themes:</label>
                <select id="theme" class="mt-1 p-2 w-full bg-gray-700 rounded" aria-label="Select Theme">
                    <option>Light</option>
                    <option>Dark</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 overflow-auto">
            <!-- Manage Items Section -->
            <div id="manage-items" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Manage Items</h2>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="text-xl font-semibold mb-4">Add New Item</h3>
                    <form id="add-item-form">
                        <div class="mb-4">
                            <label for="item-name" class="block text-sm">Item Name</label>
                            <input type="text" id="item-name" class="w-full p-2 border rounded" aria-label="Item Name" required>
                        </div>
                        <div class="mb-4">
                            <label for="item-price" class="block text-sm">Item Price (LKR)</label>
                            <input type="number" id="item-price" class="w-full p-2 border rounded" aria-label="Item Price in LKR" required>
                        </div>
                        <div class="mb-4">
                            <label for="item-stock" class="block text-sm">Stock</label>
                            <input type="number" id="item-stock" class="w-full p-2 border rounded" aria-label="Stock Quantity" required>
                        </div>
                        <div class="mb-4">
                            <label for="item-author" class="block text-sm">Author</label>
                            <input type="text" id="item-author" class="w-full p-2 border rounded" aria-label="Author Name" required>
                        </div>
                        <div class="mb-4">
                            <label for="item-image" class="block text-sm">Item Image</label>
                            <input type="file" id="item-image" accept="image/*" class="w-full p-2 border rounded" aria-label="Upload Item Image">
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Add Item</button>
                    </form>
                    <div id="recent-items" class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Recently Added Items</h3>
                        <table class="w-full border">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="p-2">Item Name</th>
                                    <th class="p-2">Price (LKR)</th>
                                    <th class="p-2">Stock</th>
                                    <th class="p-2">Author</th>
                                    <th class="p-2">Image</th>
                                </tr>
                            </thead>
                            <tbody id="recent-items-table"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white p-6 rounded shadow mt-6">
                    <h3 class="text-xl font-semibold mb-4">Inventory</h3>
                    <table class="w-full border">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2">Item Name</th>
                                <th class="p-2">Price (LKR)</th>
                                <th class="p-2">Stock</th>
                                <th class="p-2">Author</th>
                                <th class="p-2">Image</th>
                                <th class="p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- View Orders Section -->
            <div id="view-orders" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Order Management</h2>
                <div class="bg-white p-6 rounded shadow">
                    <div class="mb-4">
                        <button class="px-4 py-2 bg-gray-200 rounded filter-btn" data-filter="all">All Orders</button>
                        <button class="px-4 py-2 bg-gray-200 rounded filter-btn" data-filter="pending">Pending</button>
                        <button class="px-4 py-2 bg-gray-200 rounded filter-btn" data-filter="completed">Completed</button>
                        <button class="px-4 py-2 bg-gray-200 rounded filter-btn" data-filter="cancelled">Cancelled</button>
                    </div>
                    <table class="w-full border">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2">Order ID</th>
                                <th class="p-2">Customer</th>
                                <th class="p-2">Total (LKR)</th>
                                <th class="p-2">Status</th>
                                <th class="p-2">Date</th>
                                <th class="p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="user-management" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">User Management</h2>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="text-xl font-semibold mb-4">Add New User</h3>
                    <form id="add-user-form">
                        <div class="mb-4">
                            <label for="user-username" class="block text-sm">Username</label>
                            <input type="text" id="user-username" class="w-full p-2 border rounded" aria-label="Username" required>
                        </div>
                        <div class="mb-4">
                            <label for="user-email" class="block text-sm">Email</label>
                            <input type="email" id="user-email" class="w-full p-2 border rounded" aria-label="Email Address" required>
                        </div>
                        <div class="mb-4">
                            <label for="user-password" class="block text-sm">Password</label>
                            <input type="password" id="user-password" class="w-full p-2 border rounded" aria-label="Password" required>
                        </div>
                        <div class="mb-4">
                            <label for="user-role" class="block text-sm">Role</label>
                            <select id="user-role" class="w-full p-2 border rounded" aria-label="User Role" required>
                                <option value="">Select Role</option>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Add User</button>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">User List</h3>
                        <table class="w-full border">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="p-2">ID</th>
                                    <th class="p-2">Username</th>
                                    <th class="p-2">Email</th>
                                    <th class="p-2">Role</th>
                                    <th class="p-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Banner Management Section -->
            <div id="banner-management" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Banner Management</h2>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="text-xl font-semibold mb-4">Current Banner</h3>
                    <img id="current-banner" src="" alt="Current Banner" class="banner-preview mb-4">
                    <p class="text-sm mb-4">Banner displays at 1200x400 (3:1). Important content should be centered.</p>
                    <h3 class="text-xl font-semibold mb-4">Upload Banner Image (Resized to 1200x400)</h3>
                    <form id="banner-form">
                        <div class="mb-4">
                            <label for="banner-image" class="block text-sm">Select Banner Image:</label>
                            <input type="file" id="banner-image" accept="image/*" class="w-full p-2 border rounded" aria-label="Upload Banner Image">
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload & Resize</button>
                    </form>
                </div>
            </div>

            <!-- Footer -->
            <footer class="mt-6 text-center">
                <p>© 2024 My Bookshop. All rights reserved.</p>
            </footer>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow">
            <h3 class="text-lg font-semibold mb-4">Confirmation</h3>
            <p id="modal-message"></p>
            <div class="mt-4 flex justify-end">
                <button id="modal-close" class="px-4 py-2 bg-gray-500 text-white rounded">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Tab Navigation
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                tabLinks.forEach(l => l.classList.remove('active'));
                tabContents.forEach(c => c.classList.add('hidden'));
                link.classList.add('active');
                document.querySelector(link.getAttribute('href')).classList.remove('hidden');
            });
        });

        // Initialize shared data storage
        if (!window.sharedData) {
            window.sharedData = {
                items: [],
                banner: null,
                lastUpdated: null
            };
        }

        // Mock Data Storage
        let items = [];
        let orders = [];
        let users = [];
        let bannerImageData = ''; // Store banner as base64 data URL

        // Sync with shared data for index.html
        if (window.sharedData) {
            items = window.sharedData.items || [];
            bannerImageData = window.sharedData.banner || '';
        }

        // Add Item
        document.getElementById('add-item-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                id: items.length + 1,
                name: document.getElementById('item-name').value,
                price: parseFloat(document.getElementById('item-price').value),
                stock: parseInt(document.getElementById('item-stock').value),
                author: document.getElementById('item-author').value,
                image: document.getElementById('item-image').files[0] ? URL.createObjectURL(document.getElementById('item-image').files[0]) : '',
                discountPrice: parseFloat(document.getElementById('item-price').value) * 0.9, // Default 10% discount
                category: 'featured' // Default category
            };
            items.push(item);
            
            // Sync with shared data
            if (window.sharedData) {
                window.sharedData.items = items;
                window.sharedData.lastUpdated = Date.now();
            }
            
            updateInventoryTable();
            updateRecentItemsTable();
            document.getElementById('add-item-form').reset();
            showModal('Item added successfully!');
        });

        // Update Inventory Table
        function updateInventoryTable() {
            const tableBody = document.getElementById('inventory-table');
            tableBody.innerHTML = '';
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.price}</td>
                    <td class="p-2">${item.stock}</td>
                    <td class="p-2">${item.author}</td>
                    <td class="p-2"><img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover"></td>
                    <td class="p-2">
                        <button class="bg-red-500 text-white px-2 py-1 rounded delete-item" data-id="${item.id}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Add Delete Item Event Listeners
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-id'));
                    items = items.filter(item => item.id !== id);
                    
                    // Sync with shared data
                    if (window.sharedData) {
                        window.sharedData.items = items;
                        window.sharedData.lastUpdated = Date.now();
                    }
                    
                    updateInventoryTable();
                    updateRecentItemsTable();
                    showModal('Item deleted successfully!');
                });
            });
        }

        // Update Recent Items Table
        function updateRecentItemsTable() {
            const tableBody = document.getElementById('recent-items-table');
            tableBody.innerHTML = '';
            items.slice(-3).forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.price}</td>
                    <td class="p-2">${item.stock}</td>
                    <td class="p-2">${item.author}</td>
                    <td class="p-2"><img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover"></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Add User
        document.getElementById('add-user-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = {
                id: users.length + 1,
                username: document.getElementById('user-username').value,
                email: document.getElementById('user-email').value,
                role: document.getElementById('user-role').value
            };
            users.push(user);
            updateUsersTable();
            document.getElementById('add-user-form').reset();
            showModal('User added successfully!');
        });

        // Update Users Table
        function updateUsersTable() {
            const tableBody = document.getElementById('users-table');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${user.id}</td>
                    <td class="p-2">${user.username}</td>
                    <td class="p-2">${user.email}</td>
                    <td class="p-2">${user.role}</td>
                    <td class="p-2">
                        <button class="bg-red-500 text-white px-2 py-1 rounded delete-user" data-id="${user.id}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Add Delete User Event Listeners
            document.querySelectorAll('.delete-user').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-id'));
                    users = users.filter(user => user.id !== id);
                    updateUsersTable();
                    showModal('User deleted successfully!');
                });
            });
        }

        // Banner Upload - Fixed to use client-side processing only
        document.getElementById('banner-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const bannerImage = document.getElementById('banner-image').files[0];
            if (!bannerImage) {
                showModal('Please select a banner image first.');
                return;
            }

            // Validate image type
            if (!bannerImage.type.startsWith('image/')) {
                showModal('Please select a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    try {
                        // Create canvas for resizing
                        const canvas = document.createElement('canvas');
                        canvas.width = 1200;
                        canvas.height = 400;
                        const ctx = canvas.getContext('2d');
                        
                        // Clear canvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // Draw resized image (center and crop if necessary)
                        const aspectRatio = img.width / img.height;
                        const canvasAspectRatio = canvas.width / canvas.height;
                        
                        let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                        
                        if (aspectRatio > canvasAspectRatio) {
                            // Image is wider, fit height and crop width
                            drawHeight = canvas.height;
                            drawWidth = canvas.height * aspectRatio;
                            offsetX = (canvas.width - drawWidth) / 2;
                        } else {
                            // Image is taller, fit width and crop height
                            drawWidth = canvas.width;
                            drawHeight = canvas.width / aspectRatio;
                            offsetY = (canvas.height - drawHeight) / 2;
                        }
                        
                        // Draw the image
                        ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight, 0, 0, canvas.width, canvas.height);
                        
                        // Convert to data URL
                        const resizedImageData = canvas.toDataURL('image/jpeg', 0.8); // 80% quality
                        
                        // Update the banner display
                        document.getElementById('current-banner').src = resizedImageData;
                        
                        // Store in local variable
                        bannerImageData = resizedImageData;
                        
                        // Sync with shared data for index.html
                        if (window.sharedData) {
                            window.sharedData.banner = resizedImageData;
                            window.sharedData.lastUpdated = Date.now();
                        }
                        
                        // Reset form
                        document.getElementById('banner-form').reset();
                        
                        showModal('Banner uploaded and resized successfully!');
                        
                    } catch (error) {
                        console.error('Error processing banner image:', error);
                        showModal('Error processing banner image: ' + error.message);
                    }
                };
                img.onerror = function() {
                    showModal('Error loading the image. Please select a valid image file.');
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                showModal('Error reading the image file.');
            };
            reader.readAsDataURL(bannerImage);
        });

        // Modal
        function showModal(message) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
            
            // Add event listener for close button (in case it's not already added)
            const closeBtn = document.getElementById('modal-close');
            if (closeBtn && !closeBtn.hasEventListener) {
                closeBtn.addEventListener('click', () => {
                    document.getElementById('modal').classList.add('hidden');
                });
                closeBtn.hasEventListener = true; // Prevent multiple listeners
            }
        }

        // Initialize banner display
        if (bannerImageData) {
            document.getElementById('current-banner').src = bannerImageData;
        }

        // Initialize
        document.querySelector('.tab-link').click();
    </script>
</body>
</html>